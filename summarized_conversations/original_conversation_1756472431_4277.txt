{'role': 'assistant', 'content': 'Finally, let\'s create a document that outlines the technical specifications for implementing webhooks in our API, which will allow real-time updates between the Legal Prejudice Risk Calculator and case management systems:\n\n<function_calls>\n<create-file file_path="prejudice_risk_calculator/webhook_implementation_spec.md">\n# Legal Prejudice Risk Calculator\n## Webhook Implementation Specification\n\nThis document provides technical specifications for implementing webhooks in the Legal Prejudice Risk Calculator API. Webhooks enable real-time communication between the Calculator and integrated case management systems, ensuring that both systems remain synchronized.\n\n## Table of Contents\n\n1. [Overview](#overview)\n2. [Webhook Architecture](#webhook-architecture)\n3. [Event Types](#event-types)\n4. [Webhook Registration](#webhook-registration)\n5. [Payload Format](#payload-format)\n6. [Security Considerations](#security-considerations)\n7. [Retry Logic](#retry-logic)\n8. [Webhook Management](#webhook-management)\n9. [Implementation Roadmap](#implementation-roadmap)\n10. [Testing Guidelines](#testing-guidelines)\n\n## Overview\n\nWebhooks provide a mechanism for the Legal Prejudice Risk Calculator to notify external systems about events in real-time. When an event occurs (such as an assessment being updated), the Calculator sends an HTTP POST request to a pre-configured URL with information about the event.\n\n### Key Benefits\n\n- **Real-time Updates**: Case management systems receive immediate notifications about changes\n- **Reduced Polling**: Eliminates the need for frequent API polling to check for updates\n- **Workflow Automation**: Enables automated workflows based on assessment events\n- **Data Consistency**: Ensures CMS data remains synchronized with assessment data\n- **User Experience**: Provides immediate feedback to users when changes occur\n\n## Webhook Architecture\n\n```\n┌─────────────────────┐                  ┌─────────────────────┐\n│                     │                  │                     │\n│  Legal Prejudice    │  HTTP POST       │  Case Management    │\n│  Risk Calculator    ├─────────────────►│  System             │\n│                     │                  │                     │\n└─────────────────────┘                  └─────────────────────┘\n         │                                        │\n         │                                        │\n         ▼                                        ▼\n┌─────────────────────┐                  ┌─────────────────────┐\n│                     │                  │                     │\n│  Event Tracking     │                  │  Webhook Handler    │\n│  System             │                  │                     │\n│                     │                  │                     │\n└─────────────────────┘                  └─────────────────────┘\n         │                                        │\n         │                                        │\n         ▼                                        ▼\n┌─────────────────────┐                  ┌─────────────────────┐\n│                     │                  │                     │\n│  Delivery           │                  │  Business Logic     │\n│  Management         │                  │  Processing         │\n│                     │                  │                     │\n└─────────────────────┘                  └─────────────────────┘\n```\n\n### Components\n\n1. **Event Tracking System**: Monitors and captures events within the Calculator\n2. **Delivery Management**: Handles webhook delivery, retries, and logging\n3. **Webhook Handler**: Receives and processes webhook payloads in the CMS\n4. **Business Logic Processing**: Takes action based on webhook events in the CMS\n\n## Event Types\n\nThe following event types will be supported by the webhook system:\n\n| Event Type | Description | Trigger |\n|------------|-------------|---------|\n| `assessment.created` | New assessment created | When a new assessment is created |\n| `assessment.updated` | Assessment details updated | When assessment metadata is changed |\n| `assessment.deleted` | Assessment deleted | When an assessment is deleted |\n| `factor.updated` | Factor ratings changed | When factor ratings are submitted or modified |\n| `result.calculated` | Risk scores calculated | When risk calculation is performed |\n| `risk_level.changed` | Risk level changed | When risk level changes (e.g., Medium to High) |\n| `link.created` | CMS link established | When assessment is linked to a CMS case |\n| `link.updated` | CMS link updated | When CMS link details are updated |\n| `link.deleted` | CMS link removed | When assessment is unlinked from a CMS case |\n\n## Webhook Registration\n\n### Registration Endpoint\n\n```\nPOST /api/v1/webhooks\n```\n\n### Request Parameters\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| `target_url` | String | Yes | URL where webhook payloads will be sent |\n| `events` | Array | Yes | Array of event types to subscribe to |\n| `description` | String | No | Human-readable description of the webhook |\n| `secret` | String | Yes | Secret used to sign webhook payloads |\n| `active` | Boolean | No | Whether the webhook is active (default: true) |\n| `content_type` | String | No | Preferred content type (default: application/json) |\n\n### Example Request\n\n```json\n{\n  "target_url": "https://cms.example.com/webhooks/prejudice-calculator",\n  "events": ["assessment.created", "result.calculated", "risk_level.changed"],\n  "description": "Production webhook for Clio integration",\n  "secret": "whsec_8fhsi2uehf28h38hd82h38hd82h3",\n  "active": true,\n  "content_type": "application/json"\n}\n```\n\n### Example Response\n\n```json\n{\n  "webhook_id": "wh_1234567890",\n  "target_url": "https://cms.example.com/webhooks/prejudice-calculator",\n  "events": ["assessment.created", "result.calculated", "risk_level.changed"],\n  "description": "Production webhook for Clio integration",\n  "active": true,\n  "content_type": "application/json",\n  "created_at": "2025-08-29T18:00:00Z"\n}\n```\n\n## Payload Format\n\n### Common Fields\n\nAll webhook payloads include the following fields:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `id` | String | Unique identifier for the webhook event |\n| `event` | String | Type of event that occurred |\n| `created_at` | String | ISO 8601 timestamp when the event occurred |\n| `data` | Object | Event-specific data payload |\n| `api_version` | String | Version of the API that generated the event |\n\n### Event-Specific Payloads\n\n#### assessment.created\n\n```json\n{\n  "id": "evt_1234567890",\n  "event": "assessment.created",\n  "created_at": "2025-08-29T18:00:00Z",\n  "api_version": "v1",\n  "data": {\n    "assessment_id": "PRF-2025-0001",\n    "case_name": "Smith v. Jones Corporation",\n    "judge_name": "Hon. Robert Williams",\n    "assessor_name": "Jane Attorney",\n    "assessment_date": "2025-08-29",\n    "case_id": "CASE-2025-0429",\n    "case_management_system_id": "CMS-12345",\n    "status": "created"\n  }\n}\n```\n\n#### factor.updated\n\n```json\n{\n  "id": "evt_1234567891",\n  "event": "factor.updated",\n  "created_at": "2025-08-29T18:15:00Z",\n  "api_version": "v1",\n  "data": {\n    "assessment_id": "PRF-2025-0001",\n    "factors_updated": [\n      {\n        "id": "financial-direct",\n        "name": "Direct financial interest",\n        "category": "Relationship-Based",\n        "likelihood": 4,\n        "impact": 5,\n        "score": 20\n      },\n      {\n        "id": "relationship-family",\n        "name": "Family relationship",\n        "category": "Relationship-Based",\n        "likelihood": 3,\n        "impact": 4,\n        "score": 12\n      }\n    ],\n    "updated_by": "Jane Attorney"\n  }\n}\n```\n\n#### result.calculated\n\n```json\n{\n  "id": "evt_1234567892",\n  "event": "result.calculated",\n  "created_at": "2025-08-29T18:30:00Z",\n  "api_version": "v1",\n  "data": {\n    "assessment_id": "PRF-2025-0001",\n    "overall_score": 18,\n    "risk_level": "High",\n    "category_scores": {\n      "relationship": 17,\n      "conduct": 12,\n      "contextual": 9\n    },\n    "high_risk_factors": [\n      {\n        "id": "financial-direct",\n        "name": "Direct financial interest",\n        "score": 20\n      }\n    ],\n    "calculated_by": "Jane Attorney"\n  }\n}\n```\n\n#### risk_level.changed\n\n```json\n{\n  "id": "evt_1234567893",\n  "event": "risk_level.changed",\n  "created_at": "2025-08-29T18:30:00Z",\n  "api_version": "v1",\n  "data": {\n    "assessment_id": "PRF-2025-0001",\n    "previous_level": "Medium",\n    "new_level": "High",\n    "previous_score": 14,\n    "new_score": 18,\n    "changed_factors": [\n      {\n        "id": "financial-direct",\n        "previous_score": 12,\n        "new_score": 20\n      }\n    ]\n  }\n}\n```\n\n## Security Considerations\n\n### Payload Signing\n\nAll webhook payloads are signed using HMAC-SHA256 to verify their authenticity. The signature is included in the `X-Prejudice-Signature` header.\n\n#### Signature Generation\n\n1. The Calculator concatenates the timestamp and the JSON payload: `{timestamp}.{payload}`\n2. The Calculator generates an HMAC-SHA256 signature using the webhook secret\n3. The signature is added to the request headers\n\n#### Signature Verification\n\n```python\nimport hmac\nimport hashlib\n\ndef verify_signature(payload_body, timestamp, signature, secret):\n    """Verify webhook signature"""\n    # Concatenate timestamp and payload\n    signed_payload = f"{timestamp}.{payload_body}"\n    \n    # Generate expected signature\n    expected_signature = hmac.new(\n        secret.encode(\'utf-8\'),\n        signed_payload.encode(\'utf-8\'),\n        hashlib.sha256\n    ).hexdigest()\n    \n    # Compare signatures using constant-time comparison\n    return hmac.compare_digest(expected_signature, signature)\n```\n\n### Additional Security Headers\n\n| Header | Description |\n|--------|-------------|\n| `X-Prejudice-Signature` | HMAC-SHA256 signature of the payload |\n| `X-Prejudice-Timestamp` | Timestamp when the webhook was sent |\n| `X-Prejudice-Event` | Type of event that triggered the webhook |\n| `X-Prejudice-Webhook-ID` | ID of the webhook configuration |\n| `User-Agent` | Set to "PrejudiceRiskCalculator-Webhook/1.0" |\n\n### Security Best Practices\n\n1. **Validate Signatures**: Always verify webhook signatures before processing\n2. **Check Timestamp**: Reject webhooks with timestamps older than 5 minutes\n3. **Use HTTPS**: Only accept webhooks over HTTPS connections\n4. **Implement Timeouts**: Set reasonable timeouts for webhook processing\n5. **Rate Limiting**: Implement rate limiting to prevent abuse\n6. **IP Filtering**: Consider restricting webhooks to known IP ranges\n7. **Idempotency**: Process webhooks idempotently to handle duplicates\n8. **Secure Secrets**: Store webhook secrets securely and rotate regularly\n\n## Retry Logic\n\n### Retry Schedule\n\nIf a webhook delivery fails (non-2xx response), the system will retry with exponential backoff:\n\n1. Initial retry: 1 minute after failure\n2. Second retry: 5 minutes after first retry\n3. Third retry: 15 minutes after second retry\n4. Fourth retry: 30 minutes after third retry\n5. Fifth retry: 1 hour after fourth retry\n6. Final retry: 3 hours after fifth retry\n\nAfter all retries are exhausted, the webhook will be marked as failed and require manual intervention.\n\n### Retry Headers\n\nEach retry includes additional headers:\n\n| Header | Description |\n|--------|-------------|\n| `X-Prejudice-Retry-Count` | Number of retry attempts (starting at 1) |\n| `X-Prejudice-Retry-Reason` | Reason for the retry (e.g., "timeout", "server_error") |\n| `X-Prejudice-Original-Timestamp` | Timestamp of the original webhook attempt |\n\n### Webhook Logs\n\nAll webhook delivery attempts are logged and accessible via the API:\n\n```\nGET /api/v1/webhooks/{webhook_id}/deliveries\n```\n\nExample response:\n\n```json\n{\n  "webhook_id": "wh_1234567890",\n  "deliveries": [\n    {\n      "id": "dlv_1234567890",\n      "event_id": "evt_1234567890",\n      "event_type": "assessment.created",\n      "target_url": "https://cms.example.com/webhooks/prejudice-calculator",\n      "status": "delivered",\n      "response_code": 200,\n      "response_body": "{\\"status\\":\\"received\\"}",\n      "created_at": "2025-08-29T18:00:00Z",\n      "delivered_at": "2025-08-29T18:00:01Z"\n    },\n    {\n      "id": "dlv_1234567891",\n      "event_id": "evt_1234567891",\n      "event_type": "factor.updated",\n      "target_url": "https://cms.example.com/webhooks/prejudice-calculator",\n      "status": "failed",\n      "response_code": 500,\n      "error": "Internal Server Error",\n      "retry_count": 6,\n      "created_at": "2025-08-29T18:15:00Z",\n      "last_attempt_at": "2025-08-29T22:50:00Z"\n    }\n  ]\n}\n```\n\n## Webhook Management\n\n### Listing Webhooks\n\n```\nGET /api/v1/webhooks\n```\n\nExample response:\n\n```json\n{\n  "webhooks": [\n    {\n      "webhook_id": "wh_1234567890",\n      "target_url": "https://cms.example.com/webhooks/prejudice-calculator",\n      "events": ["assessment.created", "result.calculated", "risk_level.changed"],\n      "description": "Production webhook for Clio integration",\n      "active": true,\n      "created_at": "2025-08-29T18:00:00Z"\n    },\n    {\n      "webhook_id": "wh_1234567891",\n      "target_url": "https://cms.example.com/webhooks/test",\n      "events": ["assessment.created"],\n      "description": "Test webhook",\n      "active": false,\n      "created_at": "2025-08-28T12:00:00Z"\n    }\n  ]\n}\n```\n\n### Retrieving a Webhook\n\n```\nGET /api/v1/webhooks/{webhook_id}\n```\n\nExample response:\n\n```json\n{\n  "webhook_id": "wh_1234567890",\n  "target_url": "https://cms.example.com/webhooks/prejudice-calculator",\n  "events": ["assessment.created", "result.calculated", "risk_level.changed"],\n  "description": "Production webhook for Clio integration",\n  "active": true,\n  "content_type": "application/json",\n  "created_at": "2025-08-29T18:00:00Z",\n  "updated_at": "2025-08-29T18:00:00Z",\n  "last_successful_delivery": "2025-08-29T18:30:01Z",\n  "delivery_success_rate": 0.95\n}\n```\n\n### Updating a Webhook\n\n```\nPUT /api/v1/webhooks/{webhook_id}\n```\n\nExample request:\n\n```json\n{\n  "events": ["assessment.created", "assessment.updated", "result.calculated", "risk_level.changed"],\n  "description": "Updated production webhook for Clio integration",\n  "active": true\n}\n```\n\nExample response:\n\n```json\n{\n  "webhook_id": "wh_1234567890",\n  "target_url": "https://cms.example.com/webhooks/prejudice-calculator",\n  "events": ["assessment.created", "assessment.updated", "result.calculated", "risk_level.changed"],\n  "description": "Updated production webhook for Clio integration",\n  "active": true,\n  "content_type": "application/json",\n  "created_at": "2025-08-29T18:00:00Z",\n  "updated_at": "2025-08-29T19:00:00Z"\n}\n```\n\n### Deleting a Webhook\n\n```\nDELETE /api/v1/webhooks/{webhook_id}\n```\n\nExample response:\n\n```json\n{\n  "webhook_id": "wh_1234567890",\n  "deleted": true,\n  "deleted_at": "2025-08-29T20:00:00Z"\n}\n```\n\n## Implementation Roadmap\n\n### Phase 1: Core Webhook Infrastructure (Months 1-2)\n\n1. **Webhook Registration API**\n   - Implement webhook registration endpoints\n   - Create webhook database schema\n   - Develop webhook configuration management\n\n2. **Event Tracking System**\n   - Implement event listeners for core events\n   - Create event queue system\n   - Develop event filtering based on subscriptions\n\n3. **Basic Delivery System**\n   - Implement webhook delivery mechanism\n   - Create signature generation\n   - Develop basic retry logic\n\n### Phase 2: Enhanced Features (Months 2-3)\n\n1. **Advanced Retry Logic**\n   - Implement exponential backoff\n   - Create delivery status tracking\n   - Develop manual retry functionality\n\n2. **Webhook Logs**\n   - Implement delivery logging\n   - Create log retrieval API\n   - Develop log retention policies\n\n3. **Security Enhancements**\n   - Implement IP filtering\n   - Create webhook secret rotation\n   - Develop rate limiting\n\n### Phase 3: Management & Monitoring (Months 3-4)\n\n1. **Webhook Dashboard**\n   - Create webhook management UI\n   - Implement delivery monitoring\n   - Develop performance analytics\n\n2. **Alerting System**\n   - Implement failure alerting\n   - Create delivery performance monitoring\n   - Develop anomaly detection\n\n3. **Documentation & Examples**\n   - Create implementation guides for CMS vendors\n   - Develop example webhook handlers\n   - Create testing tools\n\n## Testing Guidelines\n\n### Webhook Testing Endpoint\n\nA dedicated testing endpoint is available for webhook development and testing:\n\n```\nPOST /api/v1/webhooks/test\n```\n\nExample request:\n\n```json\n{\n  "target_url": "https://requestbin.com/r/your-test-endpoint",\n  "event": "assessment.created",\n  "include_sample_data": true\n}\n```\n\nExample response:\n\n```json\n{\n  "test_id": "test_1234567890",\n  "target_url": "https://requestbin.com/r/your-test-endpoint",\n  "event": "assessment.created",\n  "status": "delivered",\n  "response_code": 200,\n  "response_body": "{\\"status\\":\\"received\\"}",\n  "request_headers": {\n    "X-Prejudice-Signature": "sha256=...",\n    "X-Prejudice-Timestamp": "2025-08-29T18:00:00Z",\n    "X-Prejudice-Event": "assessment.created",\n    "Content-Type": "application/json"\n  },\n  "request_body": "{\\"id\\":\\"evt_test\\",\\"event\\":\\"assessment.created\\",...}",\n  "created_at": "2025-08-29T18:00:00Z",\n  "delivered_at": "2025-08-29T18:00:01Z"\n}\n```\n\n### Testing Best Practices\n\n1. **Use Test Mode**: Register webhooks in test mode during development\n2. **Verify Signatures**: Implement signature verification from the start\n3. **Handle Duplicates**: Design handlers to be idempotent\n4. **Log Payloads**: Store raw webhook payloads for debugging\n5. **Implement Timeouts**: Set appropriate timeouts for webhook processing\n6. **Test Failure Scenarios**: Verify retry behavior by simulating failures\n7. **Load Testing**: Test webhook handler performance under load\n8. **Monitor Deliveries**: Track webhook delivery success rates\n\n### Sample Webhook Handler\n\n```python\nfrom flask import Flask, request, jsonify\nimport hmac\nimport hashlib\nimport time\nimport json\n\napp = Flask(__name__)\n\n# Your webhook secret\nWEBHOOK_SECRET = "whsec_8fhsi2uehf28h38hd82h38hd82h3"\n\n@app.route(\'/webhooks/prejudice-calculator\', methods=[\'POST\'])\ndef handle_webhook():\n    # Get the signature and timestamp from headers\n    signature = request.headers.get(\'X-Prejudice-Signature\', \'\')\n    timestamp = request.headers.get(\'X-Prejudice-Timestamp\', \'\')\n    event_type = request.headers.get(\'X-Prejudice-Event\', \'\')\n    \n    # Get the raw request body\n    payload_body = request.data.decode(\'utf-8\')\n    \n    # Verify the signature\n    if not verify_signature(payload_body, timestamp, signature, WEBHOOK_SECRET):\n        return jsonify({"error": "Invalid signature"}), 401\n    \n    # Check timestamp to prevent replay attacks\n    current_time = time.time()\n    webhook_time = int(timestamp)\n    if current_time - webhook_time > 300:  # 5 minutes\n        return jsonify({"error": "Webhook too old"}), 400\n    \n    # Parse the payload\n    try:\n        payload = json.loads(payload_body)\n    except json.JSONDecodeError:\n        return jsonify({"error": "Invalid JSON"}), 400\n    \n    # Process the webhook based on event type\n    if event_type == \'assessment.created\':\n        process_assessment_created(payload)\n    elif event_type == \'result.calculated\':\n        process_result_calculated(payload)\n    elif event_type == \'risk_level.changed\':\n        process_risk_level_changed(payload)\n    else:\n        # Log unknown event type but return success\n        print(f"Unknown event type: {event_type}")\n    \n    # Return success response\n    return jsonify({"status": "received"}), 200\n\ndef verify_signature(payload_body, timestamp, signature, secret):\n    """Verify webhook signature"""\n    # Concatenate timestamp and payload\n    signed_payload = f"{timestamp}.{payload_body}"\n    \n    # Generate expected signature\n    expected_signature = hmac.new(\n        secret.encode(\'utf-8\'),\n        signed_payload.encode(\'utf-8\'),\n        hashlib.sha256\n    ).hexdigest()\n    \n    # Compare signatures using constant-time comparison\n    return hmac.compare_digest(expected_signature, signature)\n\ndef process_assessment_created(payload):\n    """Process assessment.created event"""\n    assessment_id = payload[\'data\'][\'assessment_id\']\n    case_name = payload[\'data\'][\'case_name\']\n    judge_name = payload[\'data\'][\'judge_name\']\n    \n    print(f"New assessment created: {assessment_id} for case {case_name} with judge {judge_name}")\n    # Add your business logic here\n\ndef process_result_calculated(payload):\n    """Process result.calculated event"""\n    assessment_id = payload[\'data\'][\'assessment_id\']\n    risk_level = payload[\'data\'][\'risk_level\']\n    overall_score = payload[\'data\'][\'overall_score\']\n    \n    print(f"Results calculated for assessment {assessment_id}: {risk_level} (score: {overall_score})")\n    # Add your business logic here\n\ndef process_risk_level_changed(payload):\n    """Process risk_level.changed event"""\n    assessment_id = payload[\'data\'][\'assessment_id\']\n    previous_level = payload[\'data\'][\'previous_level\']\n    new_level = payload[\'data\'][\'new_level\']\n    \n    print(f"Risk level changed for assessment {assessment_id}: {previous_level} -> {new_level}")\n    # Add your business logic here\n\nif __name__ == \'__main__\':\n    app.run(port=5000)\n```\n\n## Conclusion\n\nThis webhook implementation specification provides a comprehensive guide for implementing real-time event notifications between the Legal Prejudice Risk Calculator and integrated case management systems. By following these guidelines, developers can create robust, secure, and efficient webhook integrations that enhance the user experience and ensure data consistency across systems.\n\nFor additional assistance or custom integration needs, contact our integration team at integration-support@prejudicerisk.example.com.\n</create-file>\n</function_calls>', 'tool_calls': None}